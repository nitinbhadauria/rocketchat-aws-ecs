{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:livechat/livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/externalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/markRoomResponded.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/offlineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/RDStation.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToCRM.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToFacebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/changeLivechatStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeByVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getCustomFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getAgentData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getInitialData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loginByToken.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/pageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/registerGuest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveSurveyFeedback.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/searchAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendMessageLivechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendOfflineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setDepartmentForVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/startVideoCall.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/transfer.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/webhookTest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/takeInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/returnAsInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendTranscript.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatExternalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/indexes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatOfficeHour.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/Livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/QueueMethods.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OfficeClock.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OmniChannel.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/sendMessageBySMS.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/unclosedLivechats.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/customFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/departmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/externalMessages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatDepartments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatManagers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatRooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatQueue.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatTriggers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatInquiries.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api.js","meteor://ðŸ’»app/packages/rocketchat:livechat/permissions.js","meteor://ðŸ’»app/packages/rocketchat:livechat/messageTypes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/roomType.js","meteor://ðŸ’»app/packages/rocketchat:livechat/config.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/departments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/sms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/users.js"],"names":["_","module","watch","require","default","v","url","WebApp","Package","webapp","Autoupdate","autoupdate","connectHandlers","use","Meteor","bindEnvironment","req","res","next","reqUrl","parse","pathname","setHeader","domainWhiteList","RocketChat","settings","get","headers","referer","isEmpty","trim","map","split","domain","contains","host","protocol","head","Assets","getText","html","autoupdateVersion","JSON","stringify","__meteor_runtime_config__","write","end","startup","roomTypes","setRoomFind","code","models","Rooms","findLivechatByCode","authz","addRoomAccessValidator","room","user","t","hasPermission","_id","callbacks","add","Error","TAPi18n","__","lng","language","priority","LOW","knowledgeEnabled","apiaiKey","apiaiLanguage","key","value","message","editedAt","token","defer","response","HTTP","post","data","query","msg","lang","sessionId","status","result","fulfillment","speech","LivechatExternalMessage","insert","rid","orig","ts","Date","e","SystemLogger","error","waitingResponse","now","setResponseByRoomId","u","username","responseDate","responseTime","getTime","postData","type","sentAt","visitor","name","email","Livechat","sendRequest","MEDIUM","sendToRDStation","livechatData","getLivechatRoomGuestInfo","options","token_rdstation","identificador","client_id","nome","phone","telefone","tags","Object","keys","customFields","forEach","field","call","console","sendToCRM","hook","open","messages","Messages","findVisibleByRoomId","sort","agentId","push","saveCRMDataByRoomId","OmniChannel","facebook","reply","page","id","text","methods","userId","method","addAgent","addManager","newStatus","statusLivechat","Users","setLivechatStatus","roomId","findOneOpenByVisitorId","closeRoom","comment","findOneById","usernames","indexOf","action","enabled","hasToken","enable","success","updateById","disable","listPages","subscribe","unsubscribe","LivechatCustomField","find","fetch","check","String","profile","servedBy","getAgentInfo","visitorToken","info","title","color","registrationForm","triggers","departments","allowSwitchingDepartments","online","offlineColor","offlineMessage","offlineSuccessMessage","offlineUnavailableMessage","displayOfflineForm","videoCall","findOpenByVisitorToken","fields","cl","length","initSettings","getInitSettings","Livechat_title","Livechat_title_color","Livechat_enabled","Livechat_registration_form","offlineTitle","Livechat_offline_title","Livechat_offline_title_color","Livechat_offline_message","Livechat_offline_success_message","Livechat_offline_form_unavailable","Livechat_display_offline_form","Language","Livechat_videocall_enabled","Jitsi_Enabled","transcript","Livechat_enable_transcript","transcriptMessage","Livechat_transcript_message","agentData","LivechatTrigger","findEnabled","trigger","pick","LivechatDepartment","findEnabledWithAgents","department","Livechat_allow_switching_departments","findOnlineAgents","count","getVisitorByToken","stampedToken","Accounts","_generateStampedLoginToken","hashStampedToken","_hashStampedToken","updateUser","$set","services","resume","loginTokens","users","update","pageInfo","savePageHistory","registerGuest","loginToken","LivechatPageVisited","keepHistoryForToken","removeAgent","customField","removeById","removeDepartment","removeManager","triggerId","validSettings","valid","every","setting","customFieldData","Match","ObjectIncluding","label","scope","visibility","test","createOrUpdateCustomField","departmentData","departmentAgents","saveDepartment","guestData","roomData","Optional","topic","ret","saveGuest","saveRoomInfo","run","s","values","visitorRoom","formData","undefined","updateData","item","updateSurveyFeedbackById","Maybe","description","Boolean","conditions","Array","actions","isString","findOneByUsername","sendMessageLivechat","guest","findOne","sendMessage","dns","Npm","header","placeholders","replace","footer","fromEmail","match","emailDomain","substr","lastIndexOf","wrapAsync","resolveMx","Email","send","to","from","replyTo","subject","substring","DDPRateLimiter","addRule","connectionId","overwrite","updateLivechatDataByToken","setDepartmentForGuest","Random","getRoom","jitsiTimeout","createWithTypeRoomIdMessageAndUser","actionLinks","icon","i18nLabel","method_id","params","jitsiRoom","transferData","departmentId","hasRole","transfer","postCatchError","resolve","err","unblock","sampleData","createdAt","lastMessageAt","productId","ip","browser","os","customerId","agent","log","statusCode","inquiryId","inquiry","LivechatInquiry","subscriptionData","alert","unread","userMentions","groupMentions","desktopNotifications","mobilePushNotifications","emailNotifications","Subscriptions","changeAgentByRoomId","takeInquiry","createCommandWithRoomIdAndUser","stream","emit","removeByRoomId","removeUsernameById","openInquiry","day","start","finish","LivechatOfficeHour","updateHours","moment","userLanguage","author","datetime","locale","format","singleMessage","emailSettings","setOperator","operator","$exists","$ne","roles","findAgents","findOnlineUserFromList","userList","$in","concat","getNextAgent","collectionObj","model","rawCollection","findAndModify","livechatCount","$inc","findVisitorByToken","closeOffice","self","openOffice","findOneVisitorByPhone","getNextVisitorUsername","settingsRaw","Settings","saveGuestById","setData","unsetData","visitorEmails","address","phoneNumber","$unset","findOneGuestByEmailAddress","emailAddress","RegExp","escapeRegExp","emails","surveyFeedback","findLivechat","filter","offset","limit","extend","parseInt","getNextLivechatRoomCode","findByVisitorToken","findByVisitorId","visitorId","responseBy","closeByRoomId","closeInfo","closedBy","closedAt","chatDuration","setLabelByRoomId","findOpenByAgent","newAgent","crmData","_Base","constructor","isClient","_initModel","findByRoomId","extraData","record","remove","tryEnsureIndex","numAgents","findByDepartmentId","createOrUpdateDepartment","showOnRegistration","agents","savedAgents","pluck","LivechatDepartmentAgents","agentsToSave","difference","removeByDepartmentIdAndAgentId","saveAgent","order","$gt","upsert","getNextAgentForDepartment","onlineUsers","onlineUsernames","getOnlineForDepartment","depAgents","findUsersInQueue","usersList","sparse","expireAfterSeconds","saveByToken","keepHistoryMiliseconds","expireAt","findByToken","multi","removeAll","findById","getStatus","newStart","newFinish","newOpen","isNowWithinHours","currentTime","utc","todaysOfficeHours","isBefore","isBetween","isOpeningTime","isSame","isClosingTime","UAParser","historyMonitorType","logger","Logger","sections","webhook","getAgents","getOnlineAgents","roomInfo","newRoom","dept","routingMethod","QueueMethods","alias","showConnecting","$addToSet","existingUser","userData","globalRoles","joinDefaultChannels","connection","userAgent","httpHeaders","clientAddress","insertUserDoc","number","_setRealName","groupable","hideByRoomIdAndUserId","findNotHiddenPublic","setTopicAndTagsById","updateNameByRoomId","closeOpenChats","forwardOpenChats","change","without","removeByRoomIdAndUserId","createUserLeaveWithRoomIdAndUser","createUserJoinWithRoomIdAndUser","callback","trying","warn","setTimeout","ua","setUA","lm","getOS","version","getBrowser","addUserRoles","removeUserFromRoles","Streamer","allowRead","roomCode","msgs","agentIds","setInterval","gatewayURL","exportDefault","pageId","SMS","sms","SMSService","getService","agentsHandler","monitorAgents","actionTimeout","onlineAgents","queue","clearTimeout","exists","runAgentLeaveAction","observeChanges","added","changed","removed","stop","UserPresenceMonitor","onSetUserStatus","publish","handle","getUsersInRole","ready","onStop","findByIds","$gte","setDate","getDate","setSeconds","getSeconds","$lte","handleDepts","Roles","createOrUpdate","Permissions","MessageTypes","registerType","system","register","instance","tabBar","isServer","Notifications","notifyRoom","setHiddenById","RoomSettingsEnum","RoomTypeConfig","RoomTypeRouteConfig","UiTextContext","LivechatRoomRoute","path","openRoom","link","sub","LivechatRoomType","identifier","route","notSubscribedTpl","template","findRoom","ChatRoom","roomName","condition","hasAllPermission","canSendMessage","getUserStatus","guestName","Session","allowRoomSettingChange","JOIN_CODE","getUiText","context","HIDE_WARNING","LEAVE_WARNING","addGroup","group","public","section","i18nDescription","enableQuery","API","v1","addRoute","authRequired","unauthorized","bodyParams","failure","urlParams","put","delete","crypto","attachments","request","signature","createHmac","body","digest","mid","rooms","first_name","last_name","sucess","service","extra","fromCountry","fromState","fromCity","role"],"mappings":"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","file":"/packages/rocketchat_livechat.js","sourcesContent":["/* globals WebApp:true */\nimport _ from 'underscore';\nimport url from 'url';\n\nWebApp = Package.webapp.WebApp;\nconst Autoupdate = Package.autoupdate.Autoupdate;\n\nWebApp.connectHandlers.use('/livechat', Meteor.bindEnvironment((req, res, next) => {\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\n\tlet domainWhiteList = RocketChat.settings.get('Livechat_AllowedDomainsList');\n\tif (req.headers.referer && !_.isEmpty(domainWhiteList.trim())) {\n\t\tdomainWhiteList = _.map(domainWhiteList.split(','), function(domain) {\n\t\t\treturn domain.trim();\n\t\t});\n\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (!_.contains(domainWhiteList, referer.host)) {\n\t\t\tres.setHeader('X-FRAME-OPTIONS', 'DENY');\n\t\t\treturn next();\n\t\t}\n\n\t\tres.setHeader('X-FRAME-OPTIONS', `ALLOW-FROM ${ referer.protocol }//${ referer.host }`);\n\t}\n\n\tconst head = Assets.getText('public/head.html');\n\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"/livechat/livechat.css?_dc=${ Autoupdate.autoupdateVersion }\">\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t__meteor_runtime_config__ = ${ JSON.stringify(__meteor_runtime_config__) };\n\t\t\t</script>\n\n\t\t\t${ head }\n\t\t</head>\n\t\t<body>\n\t\t\t<script type=\"text/javascript\" src=\"/livechat/livechat.js?_dc=${ Autoupdate.autoupdateVersion }\"></script>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n}));\n","Meteor.startup(() => {\n\tRocketChat.roomTypes.setRoomFind('l', (code) => {\n\t\treturn RocketChat.models.Rooms.findLivechatByCode(code);\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room.t === 'l' && RocketChat.authz.hasPermission(user._id, 'view-livechat-rooms');\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room.t === 'l' && room.v && room.v._id === user._id;\n\t});\n\n\tRocketChat.callbacks.add('beforeLeaveRoom', function(user, room) {\n\t\tif (room.t !== 'l') {\n\t\t\treturn user;\n\t\t}\n\t\tthrow new Meteor.Error(TAPi18n.__('You_cant_leave_a_livechat_room_Please_use_the_close_button', {\n\t\t\tlng: user.language || RocketChat.settings.get('language') || 'en'\n\t\t}));\n\t}, RocketChat.callbacks.priority.LOW, 'cant-leave-room');\n});\n","/* globals HTTP, SystemLogger */\nimport _ from 'underscore';\n\nlet knowledgeEnabled = false;\nlet apiaiKey = '';\nlet apiaiLanguage = 'en';\nRocketChat.settings.get('Livechat_Knowledge_Enabled', function(key, value) {\n\tknowledgeEnabled = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Key', function(key, value) {\n\tapiaiKey = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Language', function(key, value) {\n\tapiaiLanguage = value;\n});\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!knowledgeEnabled) {\n\t\treturn message;\n\t}\n\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message hasn't a token, it was not sent by the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\ttry {\n\t\t\tconst response = HTTP.post('https://api.api.ai/api/query?v=20150910', {\n\t\t\t\tdata: {\n\t\t\t\t\tquery: message.msg,\n\t\t\t\t\tlang: apiaiLanguage,\n\t\t\t\t\tsessionId: room._id\n\t\t\t\t},\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json; charset=utf-8',\n\t\t\t\t\t'Authorization': `Bearer ${ apiaiKey }`\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (response.data && response.data.status.code === 200 && !_.isEmpty(response.data.result.fulfillment.speech)) {\n\t\t\t\tRocketChat.models.LivechatExternalMessage.insert({\n\t\t\t\t\trid: message.rid,\n\t\t\t\t\tmsg: response.data.result.fulfillment.speech,\n\t\t\t\t\torig: message._id,\n\t\t\t\t\tts: new Date()\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error using Api.ai ->', e);\n\t\t}\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'externalWebHook');\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// check if room is yet awaiting for response\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.waitingResponse)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent by the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.setResponseByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: message.u._id,\n\t\t\t\tusername: message.u.username\n\t\t\t},\n\t\t\tresponseDate: now,\n\t\t\tresponseTime: (now.getTime() - room.ts) / 1000\n\t\t});\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'markRoomResponded');\n","RocketChat.callbacks.add('livechat.offlineMessage', (data) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_offline_msg')) {\n\t\treturn data;\n\t}\n\n\tconst postData = {\n\t\ttype: 'LivechatOfflineMessage',\n\t\tsentAt: new Date(),\n\t\tvisitor: {\n\t\t\tname: data.name,\n\t\t\temail: data.email\n\t\t},\n\t\tmessage: data.message\n\t};\n\n\tRocketChat.Livechat.sendRequest(postData);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-email-offline-message');\n","function sendToRDStation(room) {\n\tif (!RocketChat.settings.get('Livechat_RDStation_Token')) {\n\t\treturn room;\n\t}\n\n\tconst livechatData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tif (!livechatData.visitor.email) {\n\t\treturn room;\n\t}\n\n\tconst options = {\n\t\theaders: {\n\t\t\t'Content-Type': 'application/json'\n\t\t},\n\t\tdata: {\n\t\t\ttoken_rdstation: RocketChat.settings.get('Livechat_RDStation_Token'),\n\t\t\tidentificador: 'rocketchat-livechat',\n\t\t\tclient_id: livechatData.visitor._id,\n\t\t\temail: livechatData.visitor.email\n\t\t}\n\t};\n\n\toptions.data.nome = livechatData.visitor.name || livechatData.visitor.username;\n\n\tif (livechatData.visitor.phone) {\n\t\toptions.data.telefone = livechatData.visitor.phone;\n\t}\n\n\tif (livechatData.tags) {\n\t\toptions.data.tags = livechatData.tags;\n\t}\n\n\tObject.keys(livechatData.customFields || {}).forEach(field => {\n\t\toptions.data[field] = livechatData.customFields[field];\n\t});\n\n\tObject.keys(livechatData.visitor.customFields || {}).forEach(field => {\n\t\toptions.data[field] = livechatData.visitor.customFields[field];\n\t});\n\n\ttry {\n\t\tHTTP.call('POST', 'https://www.rdstation.com.br/api/1.3/conversions', options);\n\t} catch (e) {\n\t\tconsole.error('Error sending lead to RD Station ->', e);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-save-info');\n","function sendToCRM(hook, room) {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_close')) {\n\t\treturn room;\n\t}\n\n\t// Do not send to CRM if the chat is still open\n\tif (hook === 'saveLivechatInfo' && room.open) {\n\t\treturn room;\n\t}\n\n\tconst postData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\tif (hook === 'closeRoom') {\n\t\tpostData.type = 'LivechatSession';\n\t} else if (hook === 'saveLivechatInfo') {\n\t\tpostData.type = 'LivechatEdit';\n\t}\n\n\tpostData.messages = [];\n\n\tRocketChat.models.Messages.findVisibleByRoomId(room._id, { sort: { ts: 1 } }).forEach((message) => {\n\t\tif (message.t) {\n\t\t\treturn;\n\t\t}\n\t\tconst msg = {\n\t\t\tusername: message.u.username,\n\t\t\tmsg: message.msg,\n\t\t\tts: message.ts\n\t\t};\n\n\t\tif (message.u.username !== postData.visitor.username) {\n\t\t\tmsg.agentId = message.u._id;\n\t\t}\n\t\tpostData.messages.push(msg);\n\t});\n\n\tconst response = RocketChat.Livechat.sendRequest(postData);\n\n\tif (response && response.data && response.data.data) {\n\t\tRocketChat.models.Rooms.saveCRMDataByRoomId(room._id, response.data.data);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', (room) => {\n\treturn sendToCRM('closeRoom', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', (room) => {\n\treturn sendToCRM('saveLivechatInfo', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-save-info');\n","import OmniChannel from '../lib/OmniChannel';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled') || !RocketChat.settings.get('Livechat_Facebook_API_Key')) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.facebook && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tOmniChannel.reply({\n\t\tpage: room.facebook.page.id,\n\t\ttoken: room.v.token,\n\t\ttext: message.msg\n\t});\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageToFacebook');\n","Meteor.methods({\n\t'livechat:addAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:addManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:changeLivechatStatus'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:changeLivechatStatus' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst newStatus = user.statusLivechat === 'available' ? 'not-available' : 'available';\n\n\t\treturn RocketChat.models.Users.setLivechatStatus(user._id, newStatus);\n\t}\n});\n","Meteor.methods({\n\t'livechat:closeByVisitor'(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByVisitorId(Meteor.userId(), roomId);\n\n\t\tif (!room || !room.open) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst language = (user && user.language) || RocketChat.settings.get('language') || 'en';\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom,\n\t\t\tcomment: TAPi18n.__('Closed_by_visitor', { lng: language })\n\t\t});\n\t}\n});\n","Meteor.methods({\n\t'livechat:closeRoom'(roomId, comment) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'close-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\tconst user = Meteor.user();\n\n\t\tif (room.usernames.indexOf(user.username) === -1 && !RocketChat.authz.hasPermission(Meteor.userId(), 'close-others-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom,\n\t\t\tcomment\n\t\t});\n\t}\n});\n","import OmniChannel from '../lib/OmniChannel';\n\nMeteor.methods({\n\t'livechat:facebook'(options) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\ttry {\n\t\t\tswitch (options.action) {\n\t\t\t\tcase 'initialState': {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tenabled: RocketChat.settings.get('Livechat_Facebook_Enabled'),\n\t\t\t\t\t\thasToken: !!RocketChat.settings.get('Livechat_Facebook_API_Key')\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tcase 'enable': {\n\t\t\t\t\tconst result = OmniChannel.enable();\n\n\t\t\t\t\tif (!result.success) {\n\t\t\t\t\t\treturn result;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', true);\n\t\t\t\t}\n\n\t\t\t\tcase 'disable': {\n\t\t\t\t\tOmniChannel.disable();\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', false);\n\t\t\t\t}\n\n\t\t\t\tcase 'list-pages': {\n\t\t\t\t\treturn OmniChannel.listPages();\n\t\t\t\t}\n\n\t\t\t\tcase 'subscribe': {\n\t\t\t\t\treturn OmniChannel.subscribe(options.page);\n\t\t\t\t}\n\n\t\t\t\tcase 'unsubscribe': {\n\t\t\t\t\treturn OmniChannel.unsubscribe(options.page);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e.response && e.response.data && e.response.data.error && e.response.data.error.response) {\n\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.response.error.message);\n\t\t\t}\n\t\t\tif (e.response && e.response.data && e.response.data.error && e.response.data.error.message) {\n\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.message);\n\t\t\t}\n\t\t\tconsole.error('Error contacting omni.rocket.chat:', e);\n\t\t\tthrow new Meteor.Error('integration-error', e.error);\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:getCustomFields'() {\n\t\treturn RocketChat.models.LivechatCustomField.find().fetch();\n\t}\n});\n","Meteor.methods({\n\t'livechat:getAgentData'(roomId) {\n\t\tcheck(roomId, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\t\tconst user = Meteor.user();\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || !user.profile || room.v.token !== user.profile.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(room.servedBy._id);\n\t}\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:getInitialData'(visitorToken) {\n\t\tconst info = {\n\t\t\tenabled: null,\n\t\t\ttitle: null,\n\t\t\tcolor: null,\n\t\t\tregistrationForm: null,\n\t\t\troom: null,\n\t\t\ttriggers: [],\n\t\t\tdepartments: [],\n\t\t\tallowSwitchingDepartments: null,\n\t\t\tonline: true,\n\t\t\tofflineColor: null,\n\t\t\tofflineMessage: null,\n\t\t\tofflineSuccessMessage: null,\n\t\t\tofflineUnavailableMessage: null,\n\t\t\tdisplayOfflineForm: null,\n\t\t\tvideoCall: null\n\t\t};\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tv: 1,\n\t\t\t\tservedBy: 1\n\t\t\t}\n\t\t}).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\tinfo.room = room[0];\n\t\t}\n\n\t\tconst initSettings = RocketChat.Livechat.getInitSettings();\n\n\t\tinfo.title = initSettings.Livechat_title;\n\t\tinfo.color = initSettings.Livechat_title_color;\n\t\tinfo.enabled = initSettings.Livechat_enabled;\n\t\tinfo.registrationForm = initSettings.Livechat_registration_form;\n\t\tinfo.offlineTitle = initSettings.Livechat_offline_title;\n\t\tinfo.offlineColor = initSettings.Livechat_offline_title_color;\n\t\tinfo.offlineMessage = initSettings.Livechat_offline_message;\n\t\tinfo.offlineSuccessMessage = initSettings.Livechat_offline_success_message;\n\t\tinfo.offlineUnavailableMessage = initSettings.Livechat_offline_form_unavailable;\n\t\tinfo.displayOfflineForm = initSettings.Livechat_display_offline_form;\n\t\tinfo.language = initSettings.Language;\n\t\tinfo.videoCall = initSettings.Livechat_videocall_enabled === true && initSettings.Jitsi_Enabled === true;\n\t\tinfo.transcript = initSettings.Livechat_enable_transcript;\n\t\tinfo.transcriptMessage = initSettings.Livechat_transcript_message;\n\n\t\tinfo.agentData = room && room[0] && room[0].servedBy && RocketChat.models.Users.getAgentInfo(room[0].servedBy._id);\n\n\t\tRocketChat.models.LivechatTrigger.findEnabled().forEach((trigger) => {\n\t\t\tinfo.triggers.push(_.pick(trigger, '_id', 'actions', 'conditions'));\n\t\t});\n\n\t\tRocketChat.models.LivechatDepartment.findEnabledWithAgents().forEach((department) => {\n\t\t\tinfo.departments.push(department);\n\t\t});\n\t\tinfo.allowSwitchingDepartments = initSettings.Livechat_allow_switching_departments;\n\n\t\tinfo.online = RocketChat.models.Users.findOnlineAgents().count() > 0;\n\n\t\treturn info;\n\t}\n});\n","Meteor.methods({\n\t'livechat:loginByToken'(token) {\n\t\tconst user = RocketChat.models.Users.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst stampedToken = Accounts._generateStampedLoginToken();\n\t\tconst hashStampedToken = Accounts._hashStampedToken(stampedToken);\n\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tservices: {\n\t\t\t\t\tresume: {\n\t\t\t\t\t\tloginTokens: [ hashStampedToken ]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tMeteor.users.update(user._id, updateUser);\n\n\t\treturn {\n\t\t\ttoken: stampedToken.token\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:pageVisited'(token, pageInfo) {\n\t\treturn RocketChat.Livechat.savePageHistory(token, pageInfo);\n\t}\n});\n","Meteor.methods({\n\t'livechat:registerGuest'({ token, name, email, department } = {}) {\n\t\tconst stampedToken = Accounts._generateStampedLoginToken();\n\t\tconst hashStampedToken = Accounts._hashStampedToken(stampedToken);\n\n\t\tconst userId = RocketChat.Livechat.registerGuest.call(this, {\n\t\t\ttoken,\n\t\t\tname,\n\t\t\temail,\n\t\t\tdepartment,\n\t\t\tloginToken: hashStampedToken\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.LivechatPageVisited.keepHistoryForToken(token);\n\n\t\treturn {\n\t\t\tuserId,\n\t\t\ttoken: stampedToken.token\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeCustomField'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\tcheck(_id, String);\n\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!customField) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom field not found', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.removeById(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeDepartment'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeDepartment(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeTrigger'(triggerId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeTrigger' });\n\t\t}\n\n\t\tcheck(triggerId, String);\n\n\t\treturn RocketChat.models.LivechatTrigger.removeById(triggerId);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveAppearance'(settings) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveAppearance' });\n\t\t}\n\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_show_agent_email',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_email'\n\t\t];\n\n\t\tconst valid = settings.every((setting) => {\n\t\t\treturn validSettings.indexOf(setting._id) !== -1;\n\t\t});\n\n\t\tif (!valid) {\n\t\t\tthrow new Meteor.Error('invalid-setting');\n\t\t}\n\n\t\tsettings.forEach((setting) => {\n\t\t\tRocketChat.settings.updateById(setting._id, setting.value);\n\t\t});\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveCustomField'(_id, customFieldData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tcheck(_id, String);\n\t\t}\n\n\t\tcheck(customFieldData, Match.ObjectIncluding({ field: String, label: String, scope: String, visibility: String }));\n\n\t\tif (!/^[0-9a-zA-Z-_]+$/.test(customFieldData.field)) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field-nmae', 'Invalid custom field name. Use only letters, numbers, hyphens and underscores.', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id);\n\t\t\tif (!customField) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom Field Not found', { method: 'livechat:saveCustomField' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.createOrUpdateCustomField(_id, customFieldData.field, customFieldData.label, customFieldData.scope, customFieldData.visibility);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveDepartment'(_id, departmentData, departmentAgents) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.saveDepartment(_id, departmentData, departmentAgents);\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveInfo'(guestData, roomData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tcheck(guestData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\tname: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tphone: Match.Optional(String)\n\t\t}));\n\n\t\tcheck(roomData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\ttopic: Match.Optional(String),\n\t\t\ttags: Match.Optional(String)\n\t\t}));\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomData._id, {fields: {t: 1, servedBy: 1}});\n\n\t\tif (room == null || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tif ((!room.servedBy || room.servedBy._id !== Meteor.userId()) && !RocketChat.authz.hasPermission(Meteor.userId(), 'save-others-livechat-room-info')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tconst ret = RocketChat.Livechat.saveGuest(guestData) && RocketChat.Livechat.saveRoomInfo(roomData, guestData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveInfo', RocketChat.models.Rooms.findOneById(roomData._id));\n\t\t});\n\n\t\treturn ret;\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.methods({\n\t'livechat:saveIntegration'(values) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveIntegration' });\n\t\t}\n\n\t\tif (typeof values['Livechat_webhookUrl'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhookUrl', s.trim(values['Livechat_webhookUrl']));\n\t\t}\n\n\t\tif (typeof values['Livechat_secret_token'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_secret_token', s.trim(values['Livechat_secret_token']));\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_close'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_close', !!values['Livechat_webhook_on_close']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_offline_msg'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_offline_msg', !!values['Livechat_webhook_on_offline_msg']);\n\t\t}\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\"]}] */\nimport _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:saveSurveyFeedback'(visitorToken, visitorRoom, formData) {\n\t\tcheck(visitorToken, String);\n\t\tcheck(visitorRoom, String);\n\t\tcheck(formData, [Match.ObjectIncluding({ name: String, value: String })]);\n\n\t\tconst visitor = RocketChat.models.Users.getVisitorByToken(visitorToken);\n\t\tconst room = RocketChat.models.Rooms.findOneById(visitorRoom);\n\n\t\tif (visitor !== undefined && room !== undefined && room.v !== undefined && visitor.profile !== undefined && room.v.token === visitor.profile.token) {\n\t\t\tconst updateData = {};\n\t\t\tfor (const item of formData) {\n\t\t\t\tif (_.contains(['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'], item.name) && _.contains(['1', '2', '3', '4', '5'], item.value)) {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t} else if (item.name === 'additionalFeedback') {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!_.isEmpty(updateData)) {\n\t\t\t\treturn RocketChat.models.Rooms.updateSurveyFeedbackById(room._id, updateData);\n\t\t\t}\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveTrigger'(trigger) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveTrigger' });\n\t\t}\n\n\t\tcheck(trigger, {\n\t\t\t_id: Match.Maybe(String),\n\t\t\tname: String,\n\t\t\tdescription: String,\n\t\t\tenabled: Boolean,\n\t\t\tconditions: Array,\n\t\t\tactions: Array\n\t\t});\n\n\t\tif (trigger._id) {\n\t\t\treturn RocketChat.models.LivechatTrigger.updateById(trigger._id, trigger);\n\t\t} else {\n\t\t\treturn RocketChat.models.LivechatTrigger.insert(trigger);\n\t\t}\n\t}\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:searchAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tif (!username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\treturn user;\n\t}\n});\n","Meteor.methods({\n\tsendMessageLivechat(message) {\n\t\tcheck(message.rid, String);\n\t\tcheck(message.token, String);\n\n\t\tconst guest = Meteor.users.findOne(Meteor.userId(), {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tdepartment: 1\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.Livechat.sendMessage({ guest, message });\n\t}\n});\n","/* globals DDPRateLimiter */\nconst dns = Npm.require('dns');\n\nMeteor.methods({\n\t'livechat:sendOfflineMessage'(data) {\n\t\tcheck(data, {\n\t\t\tname: String,\n\t\t\temail: String,\n\t\t\tmessage: String\n\t\t});\n\n\t\tif (!RocketChat.settings.get('Livechat_display_offline_form')) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tconst message = (`${ data.message }`).replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2');\n\n\t\tconst html = `\n\t\t\t<h1>New livechat message</h1>\n\t\t\t<p><strong>Visitor name:</strong> ${ data.name }</p>\n\t\t\t<p><strong>Visitor email:</strong> ${ data.email }</p>\n\t\t\t<p><strong>Message:</strong><br>${ message }</p>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\tif (RocketChat.settings.get('Livechat_validate_offline_email')) {\n\t\t\tconst emailDomain = data.email.substr(data.email.lastIndexOf('@') + 1);\n\n\t\t\ttry {\n\t\t\t\tMeteor.wrapAsync(dns.resolveMx)(emailDomain);\n\t\t\t} catch (e) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email-address', 'Invalid email address', { method: 'livechat:sendOfflineMessage' });\n\t\t\t}\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send({\n\t\t\t\tto: RocketChat.settings.get('Livechat_offline_email'),\n\t\t\t\tfrom: `${ data.name } - ${ data.email } <${ fromEmail }>`,\n\t\t\t\treplyTo: `${ data.name } <${ data.email }>`,\n\t\t\t\tsubject: `Livechat offline message from ${ data.name }: ${ (`${ data.message }`).substring(0, 20) }`,\n\t\t\t\thtml: header + html + footer\n\t\t\t});\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.offlineMessage', data);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendOfflineMessage',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","Meteor.methods({\n\t'livechat:setCustomField'(token, key, value, overwrite = true) {\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(key);\n\t\tif (customField) {\n\t\t\tif (customField.scope === 'room') {\n\t\t\t\treturn RocketChat.models.Rooms.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t} else {\n\t\t\t\t// Save in user\n\t\t\t\treturn RocketChat.models.Users.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\t'livechat:setDepartmentForVisitor'({ token, department } = {}) {\n\t\tRocketChat.Livechat.setDepartmentForGuest.call(this, {\n\t\t\ttoken,\n\t\t\tdepartment\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.LivechatPageVisited.keepHistoryForToken(token);\n\n\t\treturn true;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"MD5\"]}] */\nMeteor.methods({\n\t'livechat:startVideoCall'(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst guest = Meteor.user();\n\n\t\tconst message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date()\n\t\t};\n\n\t\tconst { room } = RocketChat.Livechat.getRoom(guest, message, { jitsiTimeout: new Date(Date.now() + 3600 * 1000) });\n\t\tmessage.rid = room._id;\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\tactionLinks: [\n\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall', params: '' },\n\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall', params: '' }\n\t\t\t]\n\t\t});\n\n\t\treturn {\n\t\t\troomId: room._id,\n\t\t\tdomain: RocketChat.settings.get('Jitsi_Domain'),\n\t\t\tjitsiRoom: RocketChat.settings.get('Jitsi_URL_Room_Prefix') + RocketChat.settings.get('uniqueID') + roomId\n\t\t};\n\t}\n});\n\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.Optional\"]}] */\nMeteor.methods({\n\t'livechat:transfer'(transferData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:transfer' });\n\t\t}\n\n\t\tcheck(transferData, {\n\t\t\troomId: String,\n\t\t\tuserId: Match.Optional(String),\n\t\t\tdepartmentId: Match.Optional(String)\n\t\t});\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(transferData.roomId);\n\n\t\tconst guest = RocketChat.models.Users.findOneById(room.v._id);\n\n\t\tconst user = Meteor.user();\n\n\t\tif (room.usernames.indexOf(user.username) === -1 && !RocketChat.authz.hasRole(Meteor.userId(), 'livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:transfer' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.transfer(room, guest, transferData);\n\t}\n});\n","/* globals HTTP */\nconst postCatchError = Meteor.wrapAsync(function(url, options, resolve) {\n\tHTTP.post(url, options, function(err, res) {\n\t\tif (err) {\n\t\t\tresolve(null, err.response);\n\t\t} else {\n\t\t\tresolve(null, res);\n\t\t}\n\t});\n});\n\nMeteor.methods({\n\t'livechat:webhookTest'() {\n\t\tthis.unblock();\n\n\t\tconst sampleData = {\n\t\t\ttype: 'LivechatSession',\n\t\t\t_id: 'fasd6f5a4sd6f8a4sdf',\n\t\t\tlabel: 'title',\n\t\t\ttopic: 'asiodojf',\n\t\t\tcode: 123123,\n\t\t\tcreatedAt: new Date(),\n\t\t\tlastMessageAt: new Date(),\n\t\t\ttags: [\n\t\t\t\t'tag1',\n\t\t\t\t'tag2',\n\t\t\t\t'tag3'\n\t\t\t],\n\t\t\tcustomFields: {\n\t\t\t\tproductId: '123456'\n\t\t\t},\n\t\t\tvisitor: {\n\t\t\t\t_id: '',\n\t\t\t\tname: 'visitor name',\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tdepartment: 'department',\n\t\t\t\temail: 'email@address.com',\n\t\t\t\tphone: '192873192873',\n\t\t\t\tip: '123.456.7.89',\n\t\t\t\tbrowser: 'Chrome',\n\t\t\t\tos: 'Linux',\n\t\t\t\tcustomFields: {\n\t\t\t\t\tcustomerId: '123456'\n\t\t\t\t}\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: 'asdf89as6df8',\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tname: 'Agent Name',\n\t\t\t\temail: 'agent@email.com'\n\t\t\t},\n\t\t\tmessages: [{\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tmsg: 'message content',\n\t\t\t\tts: new Date()\n\t\t\t}, {\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tagentId: 'asdf89as6df8',\n\t\t\t\tmsg: 'message content from agent',\n\t\t\t\tts: new Date()\n\t\t\t}]\n\t\t};\n\n\t\tconst options = {\n\t\t\theaders: {\n\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t},\n\t\t\tdata: sampleData\n\t\t};\n\n\t\tconst response = postCatchError(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\n\t\tconsole.log('response ->', response);\n\n\t\tif (response && response.statusCode && response.statusCode === 200) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-webhook-response');\n\t\t}\n\t}\n});\n\n","Meteor.methods({\n\t'livechat:takeInquiry'(inquiryId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOneById(inquiryId);\n\n\t\tif (!inquiry || inquiry.status === 'taken') {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Inquiry already taken', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tconst agent = {\n\t\t\tagentId: user._id,\n\t\t\tusername: user.username\n\t\t};\n\n\t\t// add subscription\n\t\tconst subscriptionData = {\n\t\t\trid: inquiry.rid,\n\t\t\tname: inquiry.name,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tcode: inquiry.code,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t// update room\n\t\tconst room = RocketChat.models.Rooms.findOneById(inquiry.rid);\n\n\t\tRocketChat.models.Rooms.changeAgentByRoomId(inquiry.rid, agent);\n\n\t\troom.servedBy = {\n\t\t\t_id: agent.agentId,\n\t\t\tusername: agent.username\n\t\t};\n\n\t\t// mark inquiry as taken\n\t\tRocketChat.models.LivechatInquiry.takeInquiry(inquiry._id);\n\n\t\t// remove sending message from guest widget\n\t\t// dont check if setting is true, because if settingwas switched off inbetween  guest entered pool,\n\t\t// and inquiry being taken, message would not be switched off.\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('connected', room._id, user);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\t// return room corresponding to inquiry (for redirecting agent to the room route)\n\t\treturn room;\n\t}\n});\n","Meteor.methods({\n\t'livechat:returnAsInquiry'(rid) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\t// //delete agent and room subscription\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\n\t\t// remove user from room\n\t\tconst username = Meteor.user().username;\n\n\t\tRocketChat.models.Rooms.removeUsernameById(rid, username);\n\n\t\t// find inquiry corresponding to room\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOne({rid});\n\n\t\t// mark inquiry as open\n\t\treturn RocketChat.models.LivechatInquiry.openInquiry(inquiry._id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveOfficeHours'(day, start, finish, open) {\n\t\tRocketChat.models.LivechatOfficeHour.updateHours(day, start, finish, open);\n\t}\n});\n","/* globals emailSettings, DDPRateLimiter */\n/* Send a transcript of the room converstation to the given email */\nimport moment from 'moment';\n\nMeteor.methods({\n\t'livechat:sendTranscript'(rid, email) {\n\t\tcheck(rid, String);\n\t\tcheck(email, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\t\tconst user = Meteor.user();\n\t\tconst userLanguage = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || !user.profile || room.v.token !== user.profile.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst messages = RocketChat.models.Messages.findVisibleByRoomId(rid, { sort: { 'ts' : 1 }});\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tlet html = '<div> <hr>';\n\t\tmessages.forEach(message => {\n\t\t\tif (message.t && ['command', 'livechat-close', 'livechat_video_call'].indexOf(message.t) !== -1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet author;\n\t\t\tif (message.u._id === Meteor.userId()) {\n\t\t\t\tauthor = TAPi18n.__('You', { lng: userLanguage });\n\t\t\t} else {\n\t\t\t\tauthor = message.u.username;\n\t\t\t}\n\n\t\t\tconst datetime = moment(message.ts).locale(userLanguage).format('LLL');\n\t\t\tconst singleMessage = `\n\t\t\t\t<p><strong>${ author }</strong>  <em>${ datetime }</em></p>\n\t\t\t\t<p>${ message.msg }</p>\n\t\t\t`;\n\t\t\thtml = html + singleMessage;\n\t\t});\n\n\t\thtml = `${ html }</div>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\temailSettings = {\n\t\t\tto: email,\n\t\t\tfrom: fromEmail,\n\t\t\treplyTo: fromEmail,\n\t\t\tsubject: TAPi18n.__('Transcript_of_your_livechat_conversation', { lng: userLanguage }),\n\t\t\thtml: header + html + footer\n\t\t};\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send(emailSettings);\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.sendTranscript', messages, email);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendTranscript',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","import _ from 'underscore';\nimport s from 'underscore.string';\n/**\n * Sets an user as (non)operator\n * @param {string} _id - User's _id\n * @param {boolean} operator - Flag to set as operator or not\n */\nRocketChat.models.Users.setOperator = function(_id, operator) {\n\tconst update = {\n\t\t$set: {\n\t\t\toperator\n\t\t}\n\t};\n\n\treturn this.update(_id, update);\n};\n\n/**\n * Gets all online agents\n * @return\n */\nRocketChat.models.Users.findOnlineAgents = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Gets all agents\n * @return\n */\nRocketChat.models.Users.findAgents = function() {\n\tconst query = {\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find online users from a list\n * @param {array} userList - array of usernames\n * @return\n */\nRocketChat.models.Users.findOnlineUserFromList = function(userList) {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t\tusername: {\n\t\t\t$in: [].concat(userList)\n\t\t}\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Get next user agent in order\n * @return {object} User from db\n */\nRocketChat.models.Users.getNextAgent = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\tconst collectionObj = this.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\tconst sort = {\n\t\tlivechatCount: 1,\n\t\tusername: 1\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tlivechatCount: 1\n\t\t}\n\t};\n\n\tconst user = findAndModify(query, sort, update);\n\tif (user && user.value) {\n\t\treturn {\n\t\t\tagentId: user.value._id,\n\t\t\tusername: user.value.username\n\t\t};\n\t} else {\n\t\treturn null;\n\t}\n};\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.getVisitorByToken = function(token, options) {\n\tconst query = {\n\t\t'profile.guest': true,\n\t\t'profile.token': token\n\t};\n\n\treturn this.findOne(query, options);\n};\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.findVisitorByToken = function(token) {\n\tconst query = {\n\t\t'profile.guest': true,\n\t\t'profile.token': token\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Change user's livechat status\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.setLivechatStatus = function(userId, status) {\n\tconst query = {\n\t\t'_id': userId\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'statusLivechat': status\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * change all livechat agents livechat status to \"not-available\"\n */\nRocketChat.models.Users.closeOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'not-available');\n\t});\n};\n\n/**\n * change all livechat agents livechat status to \"available\"\n */\nRocketChat.models.Users.openOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'available');\n\t});\n};\n\nRocketChat.models.Users.updateLivechatDataByToken = function(token, key, value, overwrite = true) {\n\tconst query = {\n\t\t'profile.token': token\n\t};\n\n\tif (!overwrite) {\n\t\tconst user = this.findOne(query, { fields: { livechatData: 1 } });\n\t\tif (user.livechatData && typeof user.livechatData[key] !== 'undefined') {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${ key }`]: value\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * Find a visitor by their phone number\n * @return {object} User from db\n */\nRocketChat.models.Users.findOneVisitorByPhone = function(phone) {\n\tconst query = {\n\t\t'phone.phoneNumber': phone\n\t};\n\n\treturn this.findOne(query);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Users.getNextVisitorUsername = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_guest_count'\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1\n\t\t}\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn `guest-${ livechatCount.value.value + 1 }`;\n};\n\nRocketChat.models.Users.saveGuestById = function(_id, data) {\n\tconst setData = {};\n\tconst unsetData = {};\n\n\tif (data.name) {\n\t\tif (!_.isEmpty(s.trim(data.name))) {\n\t\t\tsetData.name = s.trim(data.name);\n\t\t} else {\n\t\t\tunsetData.name = 1;\n\t\t}\n\t}\n\n\tif (data.email) {\n\t\tif (!_.isEmpty(s.trim(data.email))) {\n\t\t\tsetData.visitorEmails = [\n\t\t\t\t{ address: s.trim(data.email) }\n\t\t\t];\n\t\t} else {\n\t\t\tunsetData.visitorEmails = 1;\n\t\t}\n\t}\n\n\tif (data.phone) {\n\t\tif (!_.isEmpty(s.trim(data.phone))) {\n\t\t\tsetData.phone = [\n\t\t\t\t{ phoneNumber: s.trim(data.phone) }\n\t\t\t];\n\t\t} else {\n\t\t\tunsetData.phone = 1;\n\t\t}\n\t}\n\n\tconst update = {};\n\n\tif (!_.isEmpty(setData)) {\n\t\tupdate.$set = setData;\n\t}\n\n\tif (!_.isEmpty(unsetData)) {\n\t\tupdate.$unset = unsetData;\n\t}\n\n\tif (_.isEmpty(update)) {\n\t\treturn true;\n\t}\n\n\treturn this.update({ _id }, update);\n};\n\nRocketChat.models.Users.findOneGuestByEmailAddress = function(emailAddress) {\n\tconst query = {\n\t\t'visitorEmails.address': new RegExp(`^${ s.escapeRegExp(emailAddress) }$`, 'i')\n\t};\n\n\treturn this.findOne(query);\n};\n\nRocketChat.models.Users.getAgentInfo = function(agentId) {\n\tconst query = {\n\t\t_id: agentId\n\t};\n\n\tconst options = {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\tcustomFields: 1\n\t\t}\n\t};\n\n\tif (RocketChat.settings.get('Livechat_show_agent_email')) {\n\t\toptions.fields.emails = 1;\n\t}\n\n\treturn this.findOne(query, options);\n};\n","import _ from 'underscore';\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Rooms.updateSurveyFeedbackById = function(_id, surveyFeedback) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tsurveyFeedback\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateLivechatDataByToken = function(token, key, value, overwrite = true) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true\n\t};\n\n\tif (!overwrite) {\n\t\tconst room = this.findOne(query, { fields: { livechatData: 1 } });\n\t\tif (room.livechatData && typeof room.livechatData[key] !== 'undefined') {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${ key }`]: value\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.findLivechat = function(filter = {}, offset = 0, limit = 20) {\n\tconst query = _.extend(filter, {\n\t\tt: 'l'\n\t});\n\n\treturn this.find(query, { sort: { ts: - 1 }, offset, limit });\n};\n\nRocketChat.models.Rooms.findLivechatByCode = function(code, fields) {\n\tcode = parseInt(code);\n\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\t// if (this.useCache) {\n\t// \treturn this.cache.findByIndex('t,code', ['l', code], options).fetch();\n\t// }\n\n\tconst query = {\n\t\tt: 'l',\n\t\tcode\n\t};\n\n\treturn this.findOne(query, options);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Rooms.getNextLivechatRoomCode = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_Room_Count'\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1\n\t\t}\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn livechatCount.value.value;\n};\n\nRocketChat.models.Rooms.findOpenByVisitorToken = function(visitorToken, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findByVisitorToken = function(visitorToken) {\n\tconst query = {\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findByVisitorId = function(visitorId) {\n\tconst query = {\n\t\t'v._id': visitorId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findOneOpenByVisitorId = function(visitorId, roomId) {\n\tconst query = {\n\t\t_id: roomId,\n\t\topen: true,\n\t\t'v._id': visitorId\n\t};\n\n\treturn this.findOne(query);\n};\n\nRocketChat.models.Rooms.setResponseByRoomId = function(roomId, response) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tresponseBy: {\n\t\t\t\t_id: response.user._id,\n\t\t\t\tusername: response.user.username\n\t\t\t},\n\t\t\tresponseDate: response.responseDate,\n\t\t\tresponseTime: response.responseTime\n\t\t},\n\t\t$unset: {\n\t\t\twaitingResponse: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.closeByRoomId = function(roomId, closeInfo) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tclosedBy: {\n\t\t\t\t_id: closeInfo.user._id,\n\t\t\t\tusername: closeInfo.user.username\n\t\t\t},\n\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\tchatDuration: closeInfo.chatDuration\n\t\t},\n\t\t$unset: {\n\t\t\topen: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.setLabelByRoomId = function(roomId, label) {\n\treturn this.update({ _id: roomId }, { $set: { label } });\n};\n\nRocketChat.models.Rooms.findOpenByAgent = function(userId) {\n\tconst query = {\n\t\topen: true,\n\t\t'servedBy._id': userId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.changeAgentByRoomId = function(roomId, newAgent) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tservedBy: {\n\t\t\t\t_id: newAgent.agentId,\n\t\t\t\tusername: newAgent.username\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.saveCRMDataByRoomId = function(roomId, crmData) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tcrmData\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n","class LivechatExternalMessage extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_external_message');\n\n\t\tif (Meteor.isClient) {\n\t\t\tthis._initModel('livechat_external_message');\n\t\t}\n\t}\n\n\t// FIND\n\tfindByRoomId(roomId, sort = { ts: -1 }) {\n\t\tconst query = { rid: roomId };\n\n\t\treturn this.find(query, { sort });\n\t}\n}\n\nRocketChat.models.LivechatExternalMessage = new LivechatExternalMessage();\n","import _ from 'underscore';\n\n/**\n * Livechat Custom Fields model\n */\nclass LivechatCustomField extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_custom_field');\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcreateOrUpdateCustomField(_id, field, label, scope, visibility, extraData) {\n\t\tconst record = {\n\t\t\tlabel,\n\t\t\tscope,\n\t\t\tvisibility\n\t\t};\n\n\t\t_.extend(record, extraData);\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\trecord._id = field;\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\treturn record;\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n}\n\nRocketChat.models.LivechatCustomField = new LivechatCustomField();\n","import _ from 'underscore';\n\n/**\n * Livechat Department model\n */\nclass LivechatDepartment extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department');\n\n\t\tthis.tryEnsureIndex({\n\t\t\tnumAgents: 1,\n\t\t\tenabled: 1\n\t\t});\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindByDepartmentId(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.find(query, options);\n\t}\n\n\tcreateOrUpdateDepartment(_id, { enabled, name, description, showOnRegistration }, agents) {\n\t\tagents = [].concat(agents);\n\n\t\tconst record = {\n\t\t\tenabled,\n\t\t\tname,\n\t\t\tdescription,\n\t\t\tnumAgents: agents.length,\n\t\t\tshowOnRegistration\n\t\t};\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\tconst savedAgents = _.pluck(RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(_id).fetch(), 'agentId');\n\t\tconst agentsToSave = _.pluck(agents, 'agentId');\n\n\t\t// remove other agents\n\t\t_.difference(savedAgents, agentsToSave).forEach((agentId) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.removeByDepartmentIdAndAgentId(_id, agentId);\n\t\t});\n\n\t\tagents.forEach((agent) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.saveAgent({\n\t\t\t\tagentId: agent.agentId,\n\t\t\t\tdepartmentId: _id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: agent.count ? parseInt(agent.count) : 0,\n\t\t\t\torder: agent.order ? parseInt(agent.order) : 0\n\t\t\t});\n\t\t});\n\n\t\treturn _.extend(record, { _id });\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n\n\tfindEnabledWithAgents() {\n\t\tconst query = {\n\t\t\tnumAgents: { $gt: 0 },\n\t\t\tenabled: true\n\t\t};\n\t\treturn this.find(query);\n\t}\n}\n\nRocketChat.models.LivechatDepartment = new LivechatDepartment();\n","import _ from 'underscore';\n/**\n * Livechat Department model\n */\nclass LivechatDepartmentAgents extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department_agents');\n\t}\n\n\tfindByDepartmentId(departmentId) {\n\t\treturn this.find({ departmentId });\n\t}\n\n\tsaveAgent(agent) {\n\t\treturn this.upsert({\n\t\t\tagentId: agent.agentId,\n\t\t\tdepartmentId: agent.departmentId\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: parseInt(agent.count),\n\t\t\t\torder: parseInt(agent.order)\n\t\t\t}\n\t\t});\n\t}\n\n\tremoveByDepartmentIdAndAgentId(departmentId, agentId) {\n\t\tthis.remove({ departmentId, agentId });\n\t}\n\n\tgetNextAgentForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tconst sort = {\n\t\t\tcount: 1,\n\t\t\torder: 1,\n\t\t\tusername: 1\n\t\t};\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tcount: 1\n\t\t\t}\n\t\t};\n\n\t\tconst collectionObj = this.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\t\tconst agent = findAndModify(query, sort, update);\n\t\tif (agent && agent.value) {\n\t\t\treturn {\n\t\t\t\tagentId: agent.value.agentId,\n\t\t\t\tusername: agent.value.username\n\t\t\t};\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetOnlineForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tconst depAgents = this.find(query);\n\n\t\tif (depAgents) {\n\t\t\treturn depAgents;\n\t\t} else {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tfindUsersInQueue(usersList) {\n\t\tconst query = {};\n\n\t\tif (!_.isEmpty(usersList)) {\n\t\t\tquery.username = {\n\t\t\t\t$in: usersList\n\t\t\t};\n\t\t}\n\n\t\tconst options = {\n\t\t\tsort: {\n\t\t\t\tdepartmentId: 1,\n\t\t\t\tcount: 1,\n\t\t\t\torder: 1,\n\t\t\t\tusername: 1\n\t\t\t}\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n}\n\nRocketChat.models.LivechatDepartmentAgents = new LivechatDepartmentAgents();\n","/**\n * Livechat Page Visited model\n */\nclass LivechatPageVisited extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_page_visited');\n\n\t\tthis.tryEnsureIndex({ 'token': 1 });\n\t\tthis.tryEnsureIndex({ 'ts': 1 });\n\n\t\t// keep history for 1 month if the visitor does not register\n\t\tthis.tryEnsureIndex({ 'expireAt': 1 }, { sparse: 1, expireAfterSeconds: 0 });\n\t}\n\n\tsaveByToken(token, pageInfo) {\n\t\t// keep history of unregistered visitors for 1 month\n\t\tconst keepHistoryMiliseconds = 2592000000;\n\n\t\treturn this.insert({\n\t\t\ttoken,\n\t\t\tpage: pageInfo,\n\t\t\tts: new Date(),\n\t\t\texpireAt: new Date().getTime() + keepHistoryMiliseconds\n\t\t});\n\t}\n\n\tfindByToken(token) {\n\t\treturn this.find({ token }, { sort : { ts: -1 }, limit: 20 });\n\t}\n\n\tkeepHistoryForToken(token) {\n\t\treturn this.update({\n\t\t\ttoken,\n\t\t\texpireAt: {\n\t\t\t\t$exists: true\n\t\t\t}\n\t\t}, {\n\t\t\t$unset: {\n\t\t\t\texpireAt: 1\n\t\t\t}\n\t\t}, {\n\t\t\tmulti: true\n\t\t});\n\t}\n}\n\nRocketChat.models.LivechatPageVisited = new LivechatPageVisited();\n","/**\n * Livechat Trigger model\n */\nclass LivechatTrigger extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_trigger');\n\t}\n\n\tupdateById(_id, data) {\n\t\treturn this.update({ _id }, { $set: data });\n\t}\n\n\tremoveAll() {\n\t\treturn this.remove({});\n\t}\n\n\tfindById(_id) {\n\t\treturn this.find({ _id });\n\t}\n\n\tremoveById(_id) {\n\t\treturn this.remove({ _id });\n\t}\n\n\tfindEnabled() {\n\t\treturn this.find({ enabled: true });\n\t}\n}\n\nRocketChat.models.LivechatTrigger = new LivechatTrigger();\n","Meteor.startup(function() {\n\tRocketChat.models.Rooms.tryEnsureIndex({ code: 1 });\n\tRocketChat.models.Rooms.tryEnsureIndex({ open: 1 }, { sparse: 1 });\n\tRocketChat.models.Users.tryEnsureIndex({ 'visitorEmails.address': 1 });\n});\n","class LivechatInquiry extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_inquiry');\n\n\t\tthis.tryEnsureIndex({ 'rid': 1 }); // room id corresponding to this inquiry\n\t\tthis.tryEnsureIndex({ 'name': 1 }); // name of the inquiry (client name for now)\n\t\tthis.tryEnsureIndex({ 'message': 1 }); // message sent by the client\n\t\tthis.tryEnsureIndex({ 'ts': 1 }); // timestamp\n\t\tthis.tryEnsureIndex({ 'code': 1 }); // (for routing)\n\t\tthis.tryEnsureIndex({ 'agents': 1}); // Id's of the agents who can see the inquiry (handle departments)\n\t\tthis.tryEnsureIndex({ 'status': 1}); // 'open', 'taken'\n\t}\n\n\tfindOneById(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId });\n\t}\n\n\t/*\n\t * mark the inquiry as taken\n\t */\n\ttakeInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'taken' }\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open\n\t */\n\topenInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'open' }\n\t\t});\n\t}\n\n\t/*\n\t * return the status of the inquiry (open or taken)\n\t */\n\tgetStatus(inquiryId) {\n\t\treturn this.findOne({'_id': inquiryId}).status;\n\t}\n}\n\nRocketChat.models.LivechatInquiry = new LivechatInquiry();\n","import moment from 'moment';\n\nclass LivechatOfficeHour extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_office_hour');\n\n\t\tthis.tryEnsureIndex({ 'day': 1 }); // the day of the week monday - sunday\n\t\tthis.tryEnsureIndex({ 'start': 1 }); // the opening hours of the office\n\t\tthis.tryEnsureIndex({ 'finish': 1 }); // the closing hours of the office\n\t\tthis.tryEnsureIndex({ 'open': 1 }); // whether or not the offices are open on this day\n\n\t\t// if there is nothing in the collection, add defaults\n\t\tif (this.find().count() === 0) {\n\t\t\tthis.insert({'day' : 'Monday', 'start' : '08:00', 'finish' : '20:00', 'code' : 1, 'open' : true });\n\t\t\tthis.insert({'day' : 'Tuesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 2, 'open' : true });\n\t\t\tthis.insert({'day' : 'Wednesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 3, 'open' : true });\n\t\t\tthis.insert({'day' : 'Thursday', 'start' : '08:00', 'finish' : '20:00', 'code' : 4, 'open' : true });\n\t\t\tthis.insert({'day' : 'Friday', 'start' : '08:00', 'finish' : '20:00', 'code' : 5, 'open' : true });\n\t\t\tthis.insert({'day' : 'Saturday', 'start' : '08:00', 'finish' : '20:00', 'code' : 6, 'open' : false });\n\t\t\tthis.insert({'day' : 'Sunday', 'start' : '08:00', 'finish' : '20:00', 'code' : 0, 'open' : false });\n\t\t}\n\t}\n\n\t/*\n\t * update the given days start and finish times and whether the office is open on that day\n\t */\n\tupdateHours(day, newStart, newFinish, newOpen) {\n\t\tthis.update({\n\t\t\tday\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstart: newStart,\n\t\t\t\tfinish: newFinish,\n\t\t\t\topen: newOpen\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n\t * Check if the current server time (utc) is within the office hours of that day\n\t * returns true or false\n\t */\n\tisNowWithinHours() {\n\t\t// get current time on server in utc\n\t\t// var ct = moment().utc();\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\t// console.log(finish.isBefore(start));\n\t\tif (finish.isBefore(start)) {\n\t\t\t// finish.day(finish.day()+1);\n\t\t\tfinish.add(1, 'days');\n\t\t}\n\n\t\tconst result = currentTime.isBetween(start, finish);\n\n\t\t// inBetween  check\n\t\treturn result;\n\t}\n\n\tisOpeningTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\n\t\treturn start.isSame(currentTime, 'minute');\n\t}\n\n\tisClosingTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\treturn finish.isSame(currentTime, 'minute');\n\t}\n}\n\nRocketChat.models.LivechatOfficeHour = new LivechatOfficeHour();\n","/* globals HTTP */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport UAParser from 'ua-parser-js';\n\nRocketChat.Livechat = {\n\thistoryMonitorType: 'url',\n\n\tlogger: new Logger('Livechat', {\n\t\tsections: {\n\t\t\twebhook: 'Webhook'\n\t\t}\n\t}),\n\n\tgetNextAgent(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getNextAgentForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.getNextAgent();\n\t\t}\n\t},\n\tgetAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findAgents();\n\t\t}\n\t},\n\tgetOnlineAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findOnlineAgents();\n\t\t}\n\t},\n\tgetRoom(guest, message, roomInfo) {\n\t\tlet room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tlet newRoom = false;\n\n\t\tif (room && !room.open) {\n\t\t\tmessage.rid = Random.id();\n\t\t\troom = null;\n\t\t}\n\n\t\tif (room == null) {\n\t\t\t// if no department selected verify if there is at least one active and pick the first\n\t\t\tif (!guest.department) {\n\t\t\t\tconst departments = RocketChat.models.LivechatDepartment.findEnabledWithAgents();\n\t\t\t\tif (departments.count() > 0) {\n\t\t\t\t\tdepartments.forEach((dept) => {\n\t\t\t\t\t\tif (!guest.department && dept.showOnRegistration) {\n\t\t\t\t\t\t\tguest.department = dept._id;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// delegate room creation to QueueMethods\n\t\t\tconst routingMethod = RocketChat.settings.get('Livechat_Routing_Method');\n\t\t\troom = RocketChat.QueueMethods[routingMethod](guest, message, roomInfo);\n\n\t\t\tnewRoom = true;\n\t\t} else {\n\t\t\troom = Meteor.call('canAccessRoom', message.rid, guest._id);\n\t\t}\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('cannot-access-room');\n\t\t}\n\n\t\treturn { room, newRoom };\n\t},\n\tsendMessage({ guest, message, roomInfo }) {\n\t\tconst { room, newRoom } = this.getRoom(guest, message, roomInfo);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\n\t\t// return messages;\n\t\treturn _.extend(RocketChat.sendMessage(guest, message, room), { newRoom, showConnecting: this.showConnecting() });\n\t},\n\tregisterGuest({ token, name, email, department, phone, loginToken, username } = {}) {\n\t\tcheck(token, String);\n\n\t\tlet userId;\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tprofile: {\n\t\t\t\t\tguest: true,\n\t\t\t\t\ttoken\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tconst user = RocketChat.models.Users.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (user) {\n\t\t\tuserId = user._id;\n\t\t\tif (loginToken) {\n\t\t\t\tif (!updateUser.$addToSet) {\n\t\t\t\t\tupdateUser.$addToSet = {};\n\t\t\t\t}\n\t\t\t\tupdateUser.$addToSet['services.resume.loginTokens'] = loginToken;\n\t\t\t}\n\t\t} else {\n\t\t\tif (!username) {\n\t\t\t\tusername = RocketChat.models.Users.getNextVisitorUsername();\n\t\t\t}\n\n\t\t\tlet existingUser = null;\n\n\t\t\tif (s.trim(email) !== '' && (existingUser = RocketChat.models.Users.findOneGuestByEmailAddress(email))) {\n\t\t\t\tif (loginToken) {\n\t\t\t\t\tif (!updateUser.$addToSet) {\n\t\t\t\t\t\tupdateUser.$addToSet = {};\n\t\t\t\t\t}\n\t\t\t\t\tupdateUser.$addToSet['services.resume.loginTokens'] = loginToken;\n\t\t\t\t}\n\n\t\t\t\tuserId = existingUser._id;\n\t\t\t} else {\n\n\t\t\t\tconst userData = {\n\t\t\t\t\tusername,\n\t\t\t\t\tglobalRoles: ['livechat-guest'],\n\t\t\t\t\tdepartment,\n\t\t\t\t\ttype: 'visitor',\n\t\t\t\t\tjoinDefaultChannels: false\n\t\t\t\t};\n\n\t\t\t\tif (this.connection) {\n\t\t\t\t\tuserData.userAgent = this.connection.httpHeaders['user-agent'];\n\t\t\t\t\tuserData.ip = this.connection.httpHeaders['x-real-ip'] || this.connection.httpHeaders['x-forwarded-for'] || this.connection.clientAddress;\n\t\t\t\t\tuserData.host = this.connection.httpHeaders.host;\n\t\t\t\t}\n\n\t\t\t\tuserId = Accounts.insertUserDoc({}, userData);\n\n\t\t\t\tif (loginToken) {\n\t\t\t\t\tupdateUser.$set.services = {\n\t\t\t\t\t\tresume: {\n\t\t\t\t\t\t\tloginTokens: [ loginToken ]\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (phone) {\n\t\t\tupdateUser.$set.phone = [\n\t\t\t\t{ phoneNumber: phone.number }\n\t\t\t];\n\t\t}\n\n\t\tif (email && email.trim() !== '') {\n\t\t\tupdateUser.$set.visitorEmails = [\n\t\t\t\t{ address: email }\n\t\t\t];\n\t\t}\n\n\t\tif (name) {\n\t\t\tRocketChat._setRealName(userId, name);\n\t\t}\n\n\t\tMeteor.users.update(userId, updateUser);\n\n\t\treturn userId;\n\t},\n\tsetDepartmentForGuest({ token, department } = {}) {\n\t\tcheck(token, String);\n\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tdepartment\n\t\t\t}\n\t\t};\n\n\t\tconst user = RocketChat.models.Users.getVisitorByToken(token, { fields: { _id: 1 } });\n\t\tif (user) {\n\t\t\treturn Meteor.users.update(user._id, updateUser);\n\t\t}\n\t\treturn false;\n\t},\n\tsaveGuest({ _id, name, email, phone }) {\n\t\tconst updateData = {};\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\t\tconst ret = RocketChat.models.Users.saveGuestById(_id, updateData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveGuest', updateData);\n\t\t});\n\n\t\treturn ret;\n\t},\n\n\tcloseRoom({ user, room, comment }) {\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.closeByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: user._id,\n\t\t\t\tusername: user.username\n\t\t\t},\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - room.ts) / 1000\n\t\t});\n\n\t\tconst message = {\n\t\t\tt: 'livechat-close',\n\t\t\tmsg: comment,\n\t\t\tgroupable: false\n\t\t};\n\n\t\tRocketChat.sendMessage(user, message, room);\n\n\t\tRocketChat.models.Subscriptions.hideByRoomIdAndUserId(room._id, user._id);\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('promptTranscript', room._id, user);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.closeRoom', room);\n\t\t});\n\n\t\treturn true;\n\t},\n\n\tgetInitSettings() {\n\t\tconst settings = {};\n\n\t\tRocketChat.models.Settings.findNotHiddenPublic([\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_allow_switching_departments',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_videocall_enabled',\n\t\t\t'Jitsi_Enabled',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message'\n\t\t]).forEach((setting) => {\n\t\t\tsettings[setting._id] = setting.value;\n\t\t});\n\n\t\treturn settings;\n\t},\n\n\tsaveRoomInfo(roomData, guestData) {\n\t\tif ((roomData.topic != null || roomData.tags != null) && !RocketChat.models.Rooms.setTopicAndTagsById(roomData._id, roomData.topic, roomData.tags)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveRoom', roomData);\n\t\t});\n\n\t\tif (!_.isEmpty(guestData.name)) {\n\t\t\treturn RocketChat.models.Rooms.setLabelByRoomId(roomData._id, guestData.name) && RocketChat.models.Subscriptions.updateNameByRoomId(roomData._id, guestData.name);\n\t\t}\n\t},\n\n\tcloseOpenChats(userId, comment) {\n\t\tconst user = RocketChat.models.Users.findOneById(userId);\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tthis.closeRoom({ user, room, comment});\n\t\t});\n\t},\n\n\tforwardOpenChats(userId) {\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tconst guest = RocketChat.models.Users.findOneById(room.v._id);\n\t\t\tthis.transfer(room, guest, { departmentId: guest.department });\n\t\t});\n\t},\n\n\tsavePageHistory(token, pageInfo) {\n\t\tif (pageInfo.change === RocketChat.Livechat.historyMonitorType) {\n\t\t\treturn RocketChat.models.LivechatPageVisited.saveByToken(token, pageInfo);\n\t\t}\n\n\t\treturn;\n\t},\n\n\ttransfer(room, guest, transferData) {\n\t\tlet agent;\n\n\t\tif (transferData.userId) {\n\t\t\tconst user = RocketChat.models.Users.findOneById(transferData.userId);\n\t\t\tagent = {\n\t\t\t\tagentId: user._id,\n\t\t\t\tusername: user.username\n\t\t\t};\n\t\t} else {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(transferData.departmentId);\n\t\t}\n\n\t\tconst servedBy = room.servedBy;\n\n\t\tif (agent && agent.agentId !== servedBy._id) {\n\t\t\troom.usernames = _.without(room.usernames, servedBy.username).concat(agent.username);\n\n\t\t\tRocketChat.models.Rooms.changeAgentByRoomId(room._id, agent);\n\n\t\t\tconst subscriptionData = {\n\t\t\t\trid: room._id,\n\t\t\t\tname: guest.name || guest.username,\n\t\t\t\talert: true,\n\t\t\t\topen: true,\n\t\t\t\tunread: 1,\n\t\t\t\tuserMentions: 1,\n\t\t\t\tgroupMentions: 0,\n\t\t\t\tcode: room.code,\n\t\t\t\tu: {\n\t\t\t\t\t_id: agent.agentId,\n\t\t\t\t\tusername: agent.username\n\t\t\t\t},\n\t\t\t\tt: 'l',\n\t\t\t\tdesktopNotifications: 'all',\n\t\t\t\tmobilePushNotifications: 'all',\n\t\t\t\temailNotifications: 'all'\n\t\t\t};\n\t\t\tRocketChat.models.Subscriptions.removeByRoomIdAndUserId(room._id, servedBy._id);\n\n\t\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(room._id, { _id: servedBy._id, username: servedBy.username });\n\t\t\tRocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, { _id: agent.agentId, username: agent.username });\n\n\t\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\t\ttype: 'agentData',\n\t\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t\t});\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tsendRequest(postData, callback, trying = 1) {\n\t\ttry {\n\t\t\tconst options = {\n\t\t\t\theaders: {\n\t\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t\t},\n\t\t\t\tdata: postData\n\t\t\t};\n\t\t\treturn HTTP.post(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\t\t} catch (e) {\n\t\t\tRocketChat.Livechat.logger.webhook.error(`Response error on ${ trying } try ->`, e);\n\t\t\t// try 10 times after 10 seconds each\n\t\t\tif (trying < 10) {\n\t\t\t\tRocketChat.Livechat.logger.webhook.warn('Will try again in 10 seconds ...');\n\t\t\t\ttrying++;\n\t\t\t\tsetTimeout(Meteor.bindEnvironment(() => {\n\t\t\t\t\tRocketChat.Livechat.sendRequest(postData, callback, trying);\n\t\t\t\t}), 10000);\n\t\t\t}\n\t\t}\n\t},\n\n\tgetLivechatRoomGuestInfo(room) {\n\t\tconst visitor = RocketChat.models.Users.findOneById(room.v._id);\n\t\tconst agent = RocketChat.models.Users.findOneById(room.servedBy._id);\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent);\n\n\t\tconst postData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.label,\n\t\t\ttopic: room.topic,\n\t\t\tcode: room.code,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\temail: null,\n\t\t\t\tphone: null,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && (`${ ua.getOS().name } ${ ua.getOS().version }`),\n\t\t\t\tbrowser: ua.getBrowser().name && (`${ ua.getBrowser().name } ${ ua.getBrowser().version }`),\n\t\t\t\tcustomFields: visitor.livechatData\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\temail: null\n\t\t\t}\n\t\t};\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails[0].address;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone[0].phoneNumber;\n\t\t}\n\n\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t}\n\n\t\treturn postData;\n\t},\n\n\taddAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, true);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'available');\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\taddManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addManager' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-manager')) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.removeUserFromRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, false);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'not-available');\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.authz.removeUserFromRoles(user._id, 'livechat-manager');\n\t},\n\n\tsaveDepartment(_id, departmentData, departmentAgents) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(departmentData, {\n\t\t\tenabled: Boolean,\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t\tshowOnRegistration: Boolean\n\t\t});\n\n\t\tcheck(departmentAgents, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String\n\t\t\t})\n\t\t]);\n\n\t\tif (_id) {\n\t\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id);\n\t\t\tif (!department) {\n\t\t\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', { method: 'livechat:saveDepartment' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.createOrUpdateDepartment(_id, departmentData, departmentAgents);\n\t},\n\n\tremoveDepartment(_id) {\n\t\tcheck(_id, String);\n\n\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!department) {\n\t\t\tthrow new Meteor.Error('department-not-found', 'Department not found', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.removeById(_id);\n\t},\n\n\tshowConnecting() {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'Guest_Pool') {\n\t\t\treturn RocketChat.settings.get('Livechat_open_inquiery_show_connecting');\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n};\n\nRocketChat.Livechat.stream = new Meteor.Streamer('livechat-room');\nRocketChat.Livechat.stream.allowRead('logged');\n\nRocketChat.settings.get('Livechat_history_monitor_type', (key, value) => {\n\tRocketChat.Livechat.historyMonitorType = value;\n});\n","import _ from 'underscore';\n\nRocketChat.QueueMethods = {\n\t/* Least Amount Queuing method:\n\t *\n\t * default method where the agent with the least number\n\t * of open chats is paired with the incoming livechat\n\t */\n\t'Least_Amount'(guest, message, roomInfo) {\n\t\tconst agent = RocketChat.Livechat.getNextAgent(guest.department);\n\t\tif (!agent) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\t// usernames: [agent.username, guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token\n\t\t\t},\n\t\t\tservedBy: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tconst subscriptionData = {\n\t\t\trid: message.rid,\n\t\t\tname: guest.name || guest.username,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tcode: roomCode,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\n\t\tRocketChat.models.Rooms.insert(room);\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\treturn room;\n\t},\n\t/* Guest Pool Queuing Method:\n\t *\n\t * An incomming livechat is created as an Inquiry\n\t * which is picked up from an agent.\n\t * An Inquiry is visible to all agents (TODO: in the correct department)\n     *\n\t * A room is still created with the initial message, but it is occupied by\n\t * only the client until paired with an agent\n\t */\n\t'Guest_Pool'(guest, message, roomInfo) {\n\t\tlet agents = RocketChat.Livechat.getOnlineAgents(guest.department);\n\n\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\tagents = RocketChat.Livechat.getAgents(guest.department);\n\t\t}\n\n\t\tif (agents.count() === 0) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst agentIds = [];\n\n\t\tagents.forEach((agent) => {\n\t\t\tif (guest.department) {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t} else {\n\t\t\t\tagentIds.push(agent._id);\n\t\t\t}\n\t\t});\n\n\t\tconst inquiry = {\n\t\t\trid: message.rid,\n\t\t\tmessage: message.msg,\n\t\t\tname: guest.name || guest.username,\n\t\t\tts: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tdepartment: guest.department,\n\t\t\tagents: agentIds,\n\t\t\tstatus: 'open',\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token\n\t\t\t},\n\t\t\tt: 'l'\n\t\t};\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\t// usernames: [guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tRocketChat.models.LivechatInquiry.insert(inquiry);\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\treturn room;\n\t}\n};\n","// Every minute check if office closed\nMeteor.setInterval(function() {\n\tif (RocketChat.settings.get('Livechat_enable_office_hours')) {\n\t\tif (RocketChat.models.LivechatOfficeHour.isOpeningTime()) {\n\t\t\tRocketChat.models.Users.openOffice();\n\t\t} else if (RocketChat.models.LivechatOfficeHour.isClosingTime()) {\n\t\t\tRocketChat.models.Users.closeOffice();\n\t\t}\n\t}\n}, 60000);\n","const gatewayURL = 'https://omni.rocket.chat';\n\nexport default {\n\tenable() {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json'\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\turl: RocketChat.settings.get('Site_Url')\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tdisable() {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json'\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tlistPages() {\n\t\tconst result = HTTP.call('GET', `${ gatewayURL }/facebook/pages`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tsubscribe(pageId) {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tunsubscribe(pageId) {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\treply({ page, token, text }) {\n\t\treturn HTTP.call('POST', `${ gatewayURL }/facebook/reply`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\tpage,\n\t\t\t\ttoken,\n\t\t\t\ttext\n\t\t\t}\n\t\t});\n\t}\n};\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.SMS.enabled) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.sms && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tconst SMSService = RocketChat.SMS.getService(RocketChat.settings.get('SMS_Service'));\n\n\tif (!SMSService) {\n\t\treturn message;\n\t}\n\n\tconst visitor = RocketChat.models.Users.getVisitorByToken(room.v.token);\n\n\tif (!visitor || !visitor.profile || !visitor.phone || visitor.phone.length === 0) {\n\t\treturn message;\n\t}\n\n\tSMSService.send(room.sms.from, visitor.phone[0].phoneNumber, message.msg);\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageBySms');\n","/* globals UserPresenceMonitor */\n\nlet agentsHandler;\nlet monitorAgents = false;\nlet actionTimeout = 60000;\n\nconst onlineAgents = {\n\tusers: {},\n\tqueue: {},\n\n\tadd(userId) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t\tdelete this.queue[userId];\n\t\t}\n\t\tthis.users[userId] = 1;\n\t},\n\n\tremove(userId, callback) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t}\n\t\tthis.queue[userId] = setTimeout(Meteor.bindEnvironment(() => {\n\t\t\tcallback();\n\n\t\t\tdelete this.users[userId];\n\t\t\tdelete this.queue[userId];\n\t\t}), actionTimeout);\n\t},\n\n\texists(userId) {\n\t\treturn !!this.users[userId];\n\t}\n};\n\nfunction runAgentLeaveAction(userId) {\n\tconst action = RocketChat.settings.get('Livechat_agent_leave_action');\n\tif (action === 'close') {\n\t\treturn RocketChat.Livechat.closeOpenChats(userId, RocketChat.settings.get('Livechat_agent_leave_comment'));\n\t} else if (action === 'forward') {\n\t\treturn RocketChat.Livechat.forwardOpenChats(userId);\n\t}\n}\n\nRocketChat.settings.get('Livechat_agent_leave_action_timeout', function(key, value) {\n\tactionTimeout = value * 1000;\n});\n\nRocketChat.settings.get('Livechat_agent_leave_action', function(key, value) {\n\tmonitorAgents = value;\n\tif (value !== 'none') {\n\t\tif (!agentsHandler) {\n\t\t\tagentsHandler = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t\t\t\tadded(id) {\n\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t},\n\t\t\t\tchanged(id, fields) {\n\t\t\t\t\tif (fields.statusLivechat && fields.statusLivechat === 'not-available') {\n\t\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoved(id) {\n\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t} else if (agentsHandler) {\n\t\tagentsHandler.stop();\n\t\tagentsHandler = null;\n\t}\n});\n\nUserPresenceMonitor.onSetUserStatus((user, status/*, statusConnection*/) => {\n\tif (!monitorAgents) {\n\t\treturn;\n\t}\n\tif (onlineAgents.exists(user._id)) {\n\t\tif (status === 'offline' || user.statusLivechat === 'not-available') {\n\t\t\tonlineAgents.remove(user._id, () => {\n\t\t\t\trunAgentLeaveAction(user._id);\n\t\t\t});\n\t\t}\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.publish('livechat:customFields', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (s.trim(_id)) {\n\t\treturn RocketChat.models.LivechatCustomField.find({ _id });\n\t}\n\n\treturn RocketChat.models.LivechatCustomField.find();\n\n});\n","Meteor.publish('livechat:departmentAgents', function(departmentId) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\treturn RocketChat.models.LivechatDepartmentAgents.find({ departmentId });\n});\n","Meteor.publish('livechat:externalMessages', function(roomId) {\n\treturn RocketChat.models.LivechatExternalMessage.findByRoomId(roomId);\n});\n","Meteor.publish('livechat:agents', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-agent').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('agentUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('agentUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('agentUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:appearance', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tconst query = {\n\t\t_id: {\n\t\t\t$in: [\n\t\t\t\t'Livechat_title',\n\t\t\t\t'Livechat_title_color',\n\t\t\t\t'Livechat_show_agent_email',\n\t\t\t\t'Livechat_display_offline_form',\n\t\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t\t'Livechat_offline_message',\n\t\t\t\t'Livechat_offline_success_message',\n\t\t\t\t'Livechat_offline_title',\n\t\t\t\t'Livechat_offline_title_color',\n\t\t\t\t'Livechat_offline_email'\n\t\t\t]\n\t\t}\n\t};\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.find(query).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatAppearance', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatAppearance', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatAppearance', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:departments', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatDepartment.findByDepartmentId(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatDepartment.find();\n\t}\n\n});\n","Meteor.publish('livechat:integration', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.findByIds(['Livechat_webhookUrl', 'Livechat_secret_token', 'Livechat_webhook_on_close', 'Livechat_webhook_on_offline_msg']).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatIntegration', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatIntegration', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatIntegration', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:managers', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-manager').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('managerUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('managerUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('managerUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:rooms', function(filter = {}, offset = 0, limit = 20) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tcheck(filter, {\n\t\tname: Match.Maybe(String), // room name to filter\n\t\tagent: Match.Maybe(String), // agent _id who is serving\n\t\tstatus: Match.Maybe(String), // either 'opened' or 'closed'\n\t\tfrom: Match.Maybe(Date),\n\t\tto: Match.Maybe(Date)\n\t});\n\n\tconst query = {};\n\tif (filter.name) {\n\t\tquery.label = new RegExp(filter.name, 'i');\n\t}\n\tif (filter.agent) {\n\t\tquery['servedBy._id'] = filter.agent;\n\t}\n\tif (filter.status) {\n\t\tif (filter.status === 'opened') {\n\t\t\tquery.open = true;\n\t\t} else {\n\t\t\tquery.open = { $exists: false };\n\t\t}\n\t}\n\tif (filter.from) {\n\t\tquery.ts = {\n\t\t\t$gte: filter.from\n\t\t};\n\t}\n\tif (filter.to) {\n\t\tfilter.to.setDate(filter.to.getDate() + 1);\n\t\tfilter.to.setSeconds(filter.to.getSeconds() - 1);\n\n\t\tif (!query.ts) {\n\t\t\tquery.ts = {};\n\t\t}\n\t\tquery.ts.$lte = filter.to;\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Rooms.findLivechat(query, offset, limit).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatRoom', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatRoom', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatRoom', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:queue', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\t// let sort = { count: 1, sort: 1, username: 1 };\n\t// let onlineUsers = {};\n\n\t// let handleUsers = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t// \tadded(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.added('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tchanged(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.changed('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tremoved(id) {\n\t// \t\tthis.removed('livechatQueueUser', id);\n\t// \t}\n\t// });\n\n\tconst self = this;\n\n\tconst handleDepts = RocketChat.models.LivechatDepartmentAgents.findUsersInQueue().observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatQueueUser', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatQueueUser', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatQueueUser', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\t// handleUsers.stop();\n\t\thandleDepts.stop();\n\t});\n});\n","Meteor.publish('livechat:triggers', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatTrigger.findById(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatTrigger.find();\n\t}\n});\n","Meteor.publish('livechat:visitorHistory', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\n\tif (room.usernames.indexOf(user.username) === -1) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (room && room.v && room.v._id) {\n\t\t// CACHE: can we stop using publications here?\n\t\treturn RocketChat.models.Rooms.findByVisitorId(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorInfo', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v._id) {\n\t\treturn RocketChat.models.Users.findById(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorPageVisited', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v.token) {\n\t\treturn RocketChat.models.LivechatPageVisited.findByToken(room.v.token);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:inquiry', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tconst query = {\n\t\tagents: this.userId,\n\t\tstatus: 'open'\n\t};\n\n\treturn RocketChat.models.LivechatInquiry.find(query);\n});\n","Meteor.publish('livechat:officeHour', function() {\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\treturn RocketChat.models.LivechatOfficeHour.find();\n});\n","import '../imports/server/rest/departments.js';\nimport '../imports/server/rest/facebook.js';\nimport '../imports/server/rest/sms.js';\nimport '../imports/server/rest/users.js';\n","import _ from 'underscore';\n\nMeteor.startup(() => {\n\tconst roles = _.pluck(RocketChat.models.Roles.find().fetch(), 'name');\n\tif (roles.indexOf('livechat-agent') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-agent');\n\t}\n\tif (roles.indexOf('livechat-manager') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-manager');\n\t}\n\tif (roles.indexOf('livechat-guest') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-guest');\n\t}\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('view-l-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-manager', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-rooms', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-livechat-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-others-livechat-room', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('save-others-livechat-room-info', ['livechat-manager']);\n\t}\n});\n","RocketChat.MessageTypes.registerType({\n\tid: 'livechat_video_call',\n\tsystem: true,\n\tmessage: 'New_videocall_request'\n});\n\nRocketChat.actionLinks.register('createLivechatCall', function(message, params, instance) {\n\tif (Meteor.isClient) {\n\t\tinstance.tabBar.open('video');\n\t}\n});\n\nRocketChat.actionLinks.register('denyLivechatCall', function(message/*, params*/) {\n\tif (Meteor.isServer) {\n\t\tconst user = Meteor.user();\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('command', message.rid, 'endCall', user);\n\t\tRocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', { _id: message._id });\n\n\t\tconst language = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\tRocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom: RocketChat.models.Rooms.findOneById(message.rid),\n\t\t\tcomment: TAPi18n.__('Videocall_declined', { lng: language })\n\t\t});\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.models.Messages.setHiddenById(message._id);\n\t\t});\n\t}\n});\n","/* globals openRoom, LivechatInquiry */\nimport {RoomSettingsEnum, RoomTypeConfig, RoomTypeRouteConfig, UiTextContext} from 'meteor/rocketchat:lib';\n\nclass LivechatRoomRoute extends RoomTypeRouteConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'live',\n\t\t\tpath: '/live/:code(\\\\d+)'\n\t\t});\n\t}\n\n\taction(params) {\n\t\topenRoom('l', params.code);\n\t}\n\n\tlink(sub) {\n\t\treturn {\n\t\t\tcode: sub.code\n\t\t};\n\t}\n}\n\nclass LivechatRoomType extends RoomTypeConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tidentifier: 'l',\n\t\t\torder: 5,\n\t\t\ticon: 'livechat',\n\t\t\tlabel: 'Livechat',\n\t\t\troute: new LivechatRoomRoute()\n\t\t});\n\n\t\tthis.notSubscribedTpl = {\n\t\t\ttemplate: 'livechatNotSubscribed'\n\t\t};\n\t}\n\n\tfindRoom(identifier) {\n\t\treturn ChatRoom.findOne({code: parseInt(identifier)});\n\t}\n\n\troomName(roomData) {\n\t\tif (!roomData.name) {\n\t\t\treturn roomData.label;\n\t\t} else {\n\t\t\treturn roomData.name;\n\t\t}\n\t}\n\n\tcondition() {\n\t\treturn RocketChat.settings.get('Livechat_enabled') && RocketChat.authz.hasAllPermission('view-l-room');\n\t}\n\n\tcanSendMessage(roomId) {\n\t\tconst room = ChatRoom.findOne({_id: roomId}, {fields: {open: 1}});\n\t\treturn room && room.open === true;\n\t}\n\n\tgetUserStatus(roomId) {\n\t\tlet guestName;\n\t\tconst room = Session.get(`roomData${ roomId }`);\n\n\t\tif (room) {\n\t\t\tguestName = room.v && room.v.username;\n\t\t} else {\n\t\t\tconst inquiry = LivechatInquiry.findOne({rid: roomId});\n\t\t\tguestName = inquiry && inquiry.v && inquiry.v.username;\n\t\t}\n\n\t\tif (guestName) {\n\t\t\treturn Session.get(`user_${ guestName }_status`);\n\t\t}\n\t}\n\n\tallowRoomSettingChange(room, setting) {\n\t\tswitch (setting) {\n\t\t\tcase RoomSettingsEnum.JOIN_CODE:\n\t\t\t\treturn false;\n\t\t\tdefault:\n\t\t\t\treturn true;\n\t\t}\n\t}\n\n\tgetUiText(context) {\n\t\tswitch (context) {\n\t\t\tcase UiTextContext.HIDE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tcase UiTextContext.LEAVE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tdefault:\n\t\t\t\treturn '';\n\t\t}\n\t}\n}\n\nRocketChat.roomTypes.add(new LivechatRoomType());\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Livechat');\n\n\tRocketChat.settings.add('Livechat_enabled', false, { type: 'boolean', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_title', 'Rocket.Chat', { type: 'string', group: 'Livechat', public: true });\n\tRocketChat.settings.add('Livechat_title_color', '#C1272D', { type: 'color', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_display_offline_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Display_offline_form'\n\t});\n\n\tRocketChat.settings.add('Livechat_validate_offline_email', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Validate_email_address'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_form_unavailable', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_form_unavailable_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_title', 'Leave a message', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Title'\n\t});\n\tRocketChat.settings.add('Livechat_offline_title_color', '#666666', {\n\t\ttype: 'color',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Color'\n\t});\n\tRocketChat.settings.add('Livechat_offline_message', 'We are not online right now. Please leave us a message:', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Instructions',\n\t\ti18nDescription: 'Instructions_to_your_visitor_fill_the_form_to_send_a_message'\n\t});\n\tRocketChat.settings.add('Livechat_offline_email', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Email_address_to_send_offline_messages',\n\t\tsection: 'Offline'\n\t});\n\tRocketChat.settings.add('Livechat_offline_success_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_success_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_registration_form', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_preregistration_form' });\n\tRocketChat.settings.add('Livechat_allow_switching_departments', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Allow_switching_departments' });\n\tRocketChat.settings.add('Livechat_show_agent_email', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_agent_email' });\n\tRocketChat.settings.add('Livechat_guest_count', 1, { type: 'int', group: 'Livechat' });\n\n\tRocketChat.settings.add('Livechat_Room_Count', 1, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Livechat_room_count'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action', 'none', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tvalues: [\n\t\t\t{ key: 'none', i18nLabel: 'None' },\n\t\t\t{ key: 'forward', i18nLabel: 'Forward' },\n\t\t\t{ key: 'close', i18nLabel: 'Close' }\n\t\t],\n\t\ti18nLabel: 'How_to_handle_open_sessions_when_agent_goes_offline'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action_timeout', 60, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: { $ne: 'none' } },\n\t\ti18nLabel: 'How_long_to_wait_after_agent_goes_offline',\n\t\ti18nDescription: 'Time_in_seconds'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_comment', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: 'close' },\n\t\ti18nLabel: 'Comment_to_leave_on_closing_session'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhookUrl', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Webhook_URL'\n\t});\n\n\tRocketChat.settings.add('Livechat_secret_token', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Secret_token'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_close', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_chat_close'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_offline_msg', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_offline_messages'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Key'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Language', 'en', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Language'\n\t});\n\n\tRocketChat.settings.add('Livechat_history_monitor_type', 'url', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Monitor_history_for_changes_on',\n\t\tvalues: [\n\t\t\t{ key: 'url', i18nLabel: 'Page_URL' },\n\t\t\t{ key: 'title', i18nLabel: 'Page_title' }\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_Routing_Method', 'Least_Amount', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tvalues: [\n\t\t\t{key: 'Least_Amount', i18nLabel: 'Least_Amount'},\n\t\t\t{key: 'Guest_Pool', i18nLabel: 'Guest_Pool'}\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_pool_with_no_agents', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Accept_with_no_online_agents',\n\t\ti18nDescription: 'Accept_incoming_livechat_requests_even_if_there_are_no_online_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_show_queue_list_link', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_queue_list_to_all_agents'\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_office_hours', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Office_hours_enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_videocall_enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Videocall_enabled',\n\t\ti18nDescription: 'Beta_feature_Depends_on_Video_Conference_to_be_enabled',\n\t\tenableQuery: { _id: 'Jitsi_Enabled', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_transcript', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_transcript_message', 'Would you like a copy of this chat emailed?', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_message',\n\t\tenableQuery: { _id: 'Livechat_enable_transcript', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_open_inquiery_show_connecting', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_open_inquiery_show_connecting',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_AllowedDomainsList', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_AllowedDomainsList',\n\t\ti18nDescription: 'Domains_allowed_to_embed_the_livechat_widget'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Secret', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours'\n\t});\n\n\tRocketChat.settings.add('Livechat_RDStation_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'RD Station',\n\t\ti18nLabel: 'RDStation_Token'\n\t});\n});\n","RocketChat.API.v1.addRoute('livechat/department', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tdepartments: RocketChat.models.LivechatDepartment.find().fetch()\n\t\t});\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tconst department = RocketChat.Livechat.saveDepartment(null, this.bodyParams.department, this.bodyParams.agents);\n\n\t\t\tif (department) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment,\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: department._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tRocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/department/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tput() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.saveDepartment(this.urlParams._id, this.bodyParams.department, this.bodyParams.agents)) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.removeDepartment(this.urlParams._id)) {\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n","import crypto from 'crypto';\n/**\n * @api {post} /livechat/facebook Send Facebook message\n * @apiName Facebook\n * @apiGroup Livechat\n *\n * @apiParam {String} mid Facebook message id\n * @apiParam {String} page Facebook pages id\n * @apiParam {String} token Facebook user's token\n * @apiParam {String} first_name Facebook user's first name\n * @apiParam {String} last_name Facebook user's last name\n * @apiParam {String} [text] Facebook message text\n * @apiParam {String} [attachments] Facebook message attachments\n */\nRocketChat.API.v1.addRoute('livechat/facebook', {\n\tpost() {\n\t\tif (!this.bodyParams.text && !this.bodyParams.attachments) {\n\t\t\treturn {\n\t\t\t\tsuccess: false\n\t\t\t};\n\t\t}\n\n\t\tif (!this.request.headers['x-hub-signature']) {\n\t\t\treturn {\n\t\t\t\tsuccess: false\n\t\t\t};\n\t\t}\n\n\t\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled')) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Integration disabled'\n\t\t\t};\n\t\t}\n\n\t\t// validate if request come from omni\n\t\tconst signature = crypto.createHmac('sha1', RocketChat.settings.get('Livechat_Facebook_API_Secret')).update(JSON.stringify(this.request.body)).digest('hex');\n\t\tif (this.request.headers['x-hub-signature'] !== `sha1=${ signature }`) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Invalid signature'\n\t\t\t};\n\t\t}\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: this.bodyParams.mid\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tfacebook: {\n\t\t\t\t\tpage: this.bodyParams.page\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tlet visitor = RocketChat.models.Users.getVisitorByToken(this.bodyParams.token);\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.profile.token).fetch();\n\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.profile.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = this.bodyParams.token;\n\n\t\t\tconst userId = RocketChat.Livechat.registerGuest({\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tname: `${ this.bodyParams.first_name } ${ this.bodyParams.last_name }`\n\t\t\t});\n\n\t\t\tvisitor = RocketChat.models.Users.findOneById(userId);\n\t\t}\n\n\t\tsendMessage.message.msg = this.bodyParams.text;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\treturn {\n\t\t\t\tsucess: true,\n\t\t\t\tmessage: RocketChat.Livechat.sendMessage(sendMessage)\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.error('Error using Facebook ->', e);\n\t\t}\n\t}\n});\n","RocketChat.API.v1.addRoute('livechat/sms-incoming/:service', {\n\tpost() {\n\t\tconst SMSService = RocketChat.SMS.getService(this.urlParams.service);\n\n\t\tconst sms = SMSService.parse(this.bodyParams);\n\n\t\tlet visitor = RocketChat.models.Users.findOneVisitorByPhone(sms.from);\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: Random.id()\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tsms: {\n\t\t\t\t\tfrom: sms.to\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.profile.token).fetch();\n\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.profile.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = Random.id();\n\n\t\t\tconst userId = RocketChat.Livechat.registerGuest({\n\t\t\t\tusername: sms.from.replace(/[^0-9]/g, ''),\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tphone: {\n\t\t\t\t\tnumber: sms.from\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvisitor = RocketChat.models.Users.findOneById(userId);\n\t\t}\n\n\t\tsendMessage.message.msg = sms.body;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\tconst message = SMSService.response.call(this, RocketChat.Livechat.sendMessage(sendMessage));\n\n\t\t\tMeteor.defer(() => {\n\t\t\t\tif (sms.extra) {\n\t\t\t\t\tif (sms.extra.fromCountry) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'country', sms.extra.fromCountry);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromState) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'state', sms.extra.fromState);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromCity) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'city', sms.extra.fromCity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn message;\n\t\t} catch (e) {\n\t\t\treturn SMSService.error.call(this, e);\n\t\t}\n\t}\n});\n","import _ from 'underscore';\n\nRocketChat.API.v1.addRoute('livechat/users/:type', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tlet role;\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tconst users = RocketChat.authz.getUsersInRole(role);\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tusers: users.fetch().map(user => ({ _id: user._id, username: user.username }))\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tusername: String\n\t\t\t});\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = RocketChat.Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = RocketChat.Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/users/:type/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username')\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tuser: null\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (RocketChat.Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (RocketChat.Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n"]}